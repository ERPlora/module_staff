{% extends "ui/module_content.html" %}
{% load i18n %}

{% block page_header %}
<ion-toolbar>
    <ion-buttons slot="start">
        <ion-back-button default-href="{% url 'staff:dashboard' %}"></ion-back-button>
    </ion-buttons>
    <ion-title>{% trans "Staff Roles" %}</ion-title>
    <ion-buttons slot="end">
        <ion-button id="add-role-btn">
            {% icon "add-outline" %}
        </ion-button>
    </ion-buttons>
</ion-toolbar>
{% endblock %}

{% block page_content %}
<div class="roles-container">
    <div id="roles-list">
        {% if roles %}
        <ion-list>
            {% for role in roles %}
            <ion-item-sliding>
                <ion-item>
                    <ion-label>
                        <h2>{{ role.name }}</h2>
                        {% if role.description %}
                        <p>{{ role.description }}</p>
                        {% endif %}
                        <p class="text-muted">{{ role.staff_count }} {% trans "staff member" %}{{ role.staff_count|pluralize }}</p>
                    </ion-label>
                    <ion-reorder slot="end"></ion-reorder>
                    <ion-badge slot="end" color="{% if role.is_active %}success{% else %}medium{% endif %}">
                        {% if role.is_active %}{% trans "Active" %}{% else %}{% trans "Inactive" %}{% endif %}
                    </ion-badge>
                </ion-item>

                <ion-item-options side="end">
                    <ion-item-option color="primary" onclick="editRole({{ role.id }}, '{{ role.name }}', '{{ role.description|default:'' }}')">
                        {% icon "create-outline" %}
                    </ion-item-option>
                    <ion-item-option color="danger"
                        hx-delete="{% url 'staff:role_delete' role.id %}"
                        hx-confirm="{% trans 'Delete this role?' %}"
                        hx-target="closest ion-item-sliding"
                        hx-swap="outerHTML">
                        {% icon "trash-outline" %}
                    </ion-item-option>
                </ion-item-options>
            </ion-item-sliding>
            {% endfor %}
        </ion-list>
        {% else %}
        <div class="empty-state">
            {% icon "shield-outline" %}
            <h3>{% trans "No Roles" %}</h3>
            <p>{% trans "Create roles to organize your staff" %}</p>
            <ion-button id="add-first-role-btn">
                {% icon "add-outline" %}
                {% trans "Add Role" %}
            </ion-button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add/Edit Role Modal -->
<ion-modal id="role-modal">
    <ion-header>
        <ion-toolbar>
            <ion-buttons slot="start">
                <ion-button onclick="closeModal()">{% trans "Cancel" %}</ion-button>
            </ion-buttons>
            <ion-title id="modal-title">{% trans "Add Role" %}</ion-title>
            <ion-buttons slot="end">
                <ion-button id="save-role-btn" onclick="saveRole()">{% trans "Save" %}</ion-button>
            </ion-buttons>
        </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding">
        <form id="role-form">
            <input type="hidden" id="role-id" name="role_id" value="">
            <ion-list>
                <ion-item>
                    <ion-input
                        id="role-name"
                        label="{% trans 'Role Name' %}"
                        label-placement="stacked"
                        name="name"
                        required>
                    </ion-input>
                </ion-item>
                <ion-item>
                    <ion-textarea
                        id="role-description"
                        label="{% trans 'Description' %}"
                        label-placement="stacked"
                        name="description"
                        rows="3">
                    </ion-textarea>
                </ion-item>
            </ion-list>
        </form>
    </ion-content>
</ion-modal>

<script>
const modal = document.getElementById('role-modal');
const modalTitle = document.getElementById('modal-title');
const roleIdInput = document.getElementById('role-id');
const roleNameInput = document.getElementById('role-name');
const roleDescInput = document.getElementById('role-description');

document.getElementById('add-role-btn').addEventListener('click', () => {
    modalTitle.textContent = '{% trans "Add Role" %}';
    roleIdInput.value = '';
    roleNameInput.value = '';
    roleDescInput.value = '';
    modal.present();
});

const addFirstBtn = document.getElementById('add-first-role-btn');
if (addFirstBtn) {
    addFirstBtn.addEventListener('click', () => {
        modalTitle.textContent = '{% trans "Add Role" %}';
        roleIdInput.value = '';
        roleNameInput.value = '';
        roleDescInput.value = '';
        modal.present();
    });
}

function editRole(id, name, description) {
    modalTitle.textContent = '{% trans "Edit Role" %}';
    roleIdInput.value = id;
    roleNameInput.value = name;
    roleDescInput.value = description;
    modal.present();
}

function closeModal() {
    modal.dismiss();
}

async function saveRole() {
    const id = roleIdInput.value;
    const name = roleNameInput.value;
    const description = roleDescInput.value;

    if (!name) {
        alert('{% trans "Name is required" %}');
        return;
    }

    const url = id ? `/modules/staff/api/roles/${id}/` : '/modules/staff/api/roles/';
    const method = id ? 'PUT' : 'POST';

    try {
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: JSON.stringify({ name, description })
        });

        if (response.ok) {
            window.location.reload();
        } else {
            const data = await response.json();
            alert(data.error || '{% trans "Error saving role" %}');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('{% trans "Error saving role" %}');
    }
}
</script>

<style>
.roles-container {
    max-width: 600px;
    margin: 0 auto;
}

.empty-state {
    text-align: center;
    padding: 48px 16px;
    color: var(--ion-color-medium);
}

.empty-state ion-icon {
    font-size: 64px;
    margin-bottom: 16px;
}

.empty-state h3 {
    margin: 0 0 8px;
    color: var(--ion-text-color);
}
</style>

{% csrf_token %}
{% endblock %}
